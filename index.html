<!DOCTYPE html>
<html>
	<head>
		<title>
			Red Neuronal by joZbuyo
		</title>
		<style>
			
			#svgRed{
				position: absolute;
				left: 0px;
				top: 40px;
				width: 35%;
				height: 90%;
				border: solid 1px;
				overflow: scroll;
			}
			
			#svgWorld{
				position: absolute;
				left: 30%;
				top: 40px;
				width: 40%;
				height: 90%;
				border: solid 1px;
				overflow: scroll;
			}
			
			
			
			#dendritasModel_Container{
				position: absolute;
				left: 20%;
				top: 40px;
				width: 20%;
				height: 90%;
				border: solid 1px;
				overflow: hidden;
			}
			#dendritasModel_toolbar{
				position: absolute;
				left: 0px;
				top: 0px;
				width: 100%;
				height: 24px;
			}
			#dendritasModel_celdas{
				position: absolute;
				left: 0px;
				top: 0px;
				width: 100%;
				height: 100%;
				overflow: scroll;
			}
			#dendritasModel_dendritas{
				position: absolute;
				left: 0px;
				top: 24px;
				width: 24px;
			};
			

			#dendritasModel_svg{
				position: absolute;
				left: 0px;
				top: 0px;
				width: 100px;
				height: 100px;
			}
			
			
			#control{
				position: absolute;
				right: 0px;
				top: 40px;
				width: 28%;
				height: 90%;
				border: solid 1px;
				font-size: 10px;
			}
			
			#svgPatronesTest{
				position: absolute;
				right: 0px;
				top: 5px;
				width: 20%;
				height: 20px;
				border: solid 1px;
				overflow: scroll;
			}
			
			
			
			
			
			#botonera{
				position: absolute;
				top: 0px;
				left: 0px;
				width: 100%;
				height: 30px;
				border-collapse:separate;
				border-spacing:5px;
			}
			.boton{
				border: solid 1px;
				cursor: pointer;
				user-select: none;
				display: table-cell;
				padding: 0px 5px 0px 5px;
				text-align: center;
				font-family: "Arial Black", Gadget, sans-serif;
				background-color: #AAAAAA;
			}
			
			#botonera #play{
				width: 60px;
			}
			#botonera #play.play{
				background-color: #66AA66;
			}
			#botonera #play.pause{
				background-color: #AA6666;
			}
			#verTensionSuperficial{
				width: 120px;
			}
			#help{
				color: #A9FFFE;
			}
			
			#plantillas{
				display: none;
			}
			
			ul {
				list-style-type: none;
				margin:0;
				padding:0;
			}


			#plantilla_sly{
			
			}
			
			li.sly
			div.sly_ref{
				left: 20px;
				width: 100%;
				font-size: 9px;
			}
			
			li.sly
			input.sly_input{
				position: relative;
				top: 0px;
				left: 0px;
				width: 90%;
			}
			
			
			
		</style>
		
	</head>
	
	<body>
		<div id="botonera">
			<div id="play" class="boton pause" title="Play o Pause al test continuo">
				Pause
			</div>
			<div id="step" class="boton" title="Ejecuta solo un test">
				Step
			</div>
			
			<div id="verTensionSuperficial" class="boton" title="Visualiza la matriz de Tensiones o de Activaciones">
				Tensiones
			</div>
			<div id="dendritasModel" class="boton" title="Despliega un panel para modelos de dendritas">
				DendritasModel
			</div>
			<div id="newRed" class="boton">
				NEW
			</div>
			<!-- div id="loadRed" class="boton"  title="Carga una red guardada en un json. (se requiere FileBackend: un nodo Vortex corriendo en un node.js)">
				LOAD
			</div>
			<div id="saveRed" class="boton" title="Guarda el estado de la red en un json. (se requiere FileBackend: un nodo Vortex corriendo en un node.js)">
				SAVE
			</div -->
			<div id="help" class="boton">
				HELP
			</div>
			
		</div>
		
		<svg id="svgRed">
		</svg>
		
		<div id="dendritasModel_Container">
			
			<div id="dendritasModel_celdas">
				<svg id="dendritasModel_svg">
				</svg>
			</div>
			<div id="dendritasModel_toolbar">
				<div id="drawMode" class="boton" title="Modo de dibujo">
					D
				</div>
				<div id="addDendrita" class="boton" title="Agrega una dendrita">
					+
				</div>
				<div id="saveModel" class="boton" title="Save">
					S
				</div>
			</div>
			<div id="dendritasModel_dendritas">
					
			</div>


		</div>
		
		<svg id="svgWorld" >
		</svg>
		
		<div id="control">
			
			<ul id="coeficientes">
				<li>COEF_AXON_UMBRAL_SPIKE</li>
				<li>COEF_AXON_ANCHO_PULSO</li>
				<li>COEF_SINAPSIS_ENTRENAMIENTO_DEFAULT</li>
				<li>COEF_SINAPSIS_ENTRENAMIENTO</li>
				<li>COEF_SINAPSIS_UMBRAL_PESO</li>
				
			<ul>
			
		</div>
		
		<svg id="svgPatronesTest" >
		  <!-- rect x="0" y="0" width="10" height="10" style="fill:rgb(150,150,150);stroke:rgb(0,0,0);stroke-width:1;" / -->
		</svg>
		
		
		<div id="plantillas">
			<li id="plantilla_sly">
				<div class="sly_ref">
				</div>
				<input class="sly_input" type="range" min="0" max="255" value="100" />
			</li>
		</div>
		
		
	</body>
	
	
	
	<script src="lib/jquery-2.1.3.min.js"></script>
	<script src="lib/snap.svg-min.js"></script>
	
	<script src="lib/vortex.min.js"></script>
	<script src="lib/socket.io.js"></script>
	<script src="lib/underscore-min.js"></script>
	
	
	<script src="GuiRed.js"></script>
	<script src="GuiMatriz.js"></script>
	<script src="Test.js"></script>
	
	
	<script src="red/Constructor.js"></script>
	
	<script src="red/Red.js"></script>
	<script src="red/Neurona.js"></script>
	<script src="red/Axon.js"></script>
	<script src="red/Dendrita.js"></script>
	<script src="red/Sinapsis.js"></script>
		
	<script>
		
		//GLOBAL PARA FÁCIL DEBUG
		var red;
		var test;
		var guiRed;
		
		
		$(function(){
			
			
			
			$('body').on('contextmenu', function(e){
				return false;
			});
			

			$('#play').on('click', function(){
				var btn_play = $('#play');
				btn_play.removeClass('pause');
				btn_play.removeClass('play');
					
				
				if(!test.running){
					test.play();
					btn_play.addClass('pause');
					btn_play.text('Pause');
				}else{
					test.stop();
					btn_play.addClass('play');
					btn_play.text('Play');
				}
			});
			
			
			$('#step').on('click', function(){
				test.step();
			});
			
			$('#verTensionSuperficial').on('click', function(){
				
				if(guiRed.modo=="DEPOLARIZACION"){
					guiRed.modo="ACTIVACION";
					$('#verTensionSuperficial').text('Activaciones');
					
				}else if(guiRed.modo=="ACTIVACION"){
					guiRed.modo="DEPOLARIZACION"
					$('#verTensionSuperficial').text('Tensiones');
					
				}
			});
			
			
			$('ul#coeficientes>li').each(function(index, item){
				
				var nameSly = $(item).text();
				
				var newLi = $('#plantilla_sly').clone()
						.attr('id', nameSly+'_container')
						.attr('class', 'sly')
						;
				
				newLi.find('div.sly_ref').text(nameSly);
				
				newLi.find('input.sly_input').attr('id', nameSly);
				
				$(item).replaceWith(newLi)
			})
			
			
			
			//global
			setCoef = function(proto, nameSly, valor, escala){
				var objSly = $('#'+ nameSly);

				if(!escala)escala=1;
				
				objSly.val(valor * escala * 255);
				proto[nameSly] = valor;

				objSly.siblings().text(nameSly + ": " + proto[nameSly]);
				
			};

			//global
			configSlyCoef = function(proto, nameSly, escala) {
				

				if(!escala)escala=1;

				var objSly = $('#'+ nameSly);
				
				
				objSly.change(function(){
					var value = ($(this).val() / 255);
					value = value / escala;
					
					
					proto[nameSly] = value.toFixed(3);
					
					$(this).siblings().text(nameSly + ": " + proto[nameSly]);
				});
				
				objSly.val(proto[nameSly] * escala * 255);
				objSly.siblings().text(nameSly + ": " + proto[nameSly]);
			};

			
			var setControlCoeficientes = function(){
				
				configSlyCoef(Axon.prototype, 'COEF_AXON_UMBRAL_SPIKE', 10);
				configSlyCoef(Axon.prototype, 'COEF_AXON_ANCHO_PULSO', 0.05);
				configSlyCoef(Sinapsis.prototype, 'COEF_SINAPSIS_ENTRENAMIENTO_DEFAULT', 100);
				configSlyCoef(Sinapsis.prototype, 'COEF_SINAPSIS_ENTRENAMIENTO', 100);
				configSlyCoef(Sinapsis.prototype, 'COEF_SINAPSIS_UMBRAL_PESO');
			
			};
			
			setControlCoeficientes();
			
			
			var setRedContext = function(){
				
				
				guiRed = new GuiRed({
					red: red
				});
				
				
				if(guiRed.modo=="DEPOLARIZACION"){
					$('#verTensionSuperficial').text('Tensiones');
				}else if(guiRed.modo=="ACTIVACION"){
					$('#verTensionSuperficial').text('Activaciones');
				}
				
				
				//DEBUG: boxEntrada y boxSalida
				// no deberían estar acá,
				//no sé como hacer para que se obtenga de la red a testear,
				//puede ser que lo guarde como dato de la red, debería poder no usarse
				
				var boxEntrada = {
					x0: 0,
					y0: red.size.y - 1,
					x1: red.size.x - 1,
					y1: red.size.y - 1
				};
				var boxSalida = {
					x0: 0,
					y0: 0,
					x1: red.size.x - 1,
					y1: 0
				};
				
				test = new Test({
					red: red,
					boxEntrada: boxEntrada,
					boxSalida: boxSalida,
					noise: false
				});
				
				
				test.onStep(function(){
					guiRed.refresh();
				});
				
			};
			
			
			$('#newRed').on('click', function(){
				//crear red
				red = new Red({
					size: {x:32,y:32},
					neuronas: {}
				});
				
				
				Constructor.red = red;
				
				var boxEntrada = {
					x0: 0,
					y0: red.size.y - 1,
					x1: red.size.x - 1,
					y1: red.size.y - 1
				};
				Constructor.makeEntrada(boxEntrada);
				
				var boxSalida = {
					x0: 0,
					y0: 0,
					x1: red.size.x - 1,
					y1: 0
				};
				Constructor.makeSalida(boxSalida);
				
				
				
				
				Constructor.insertarAxones({
					modo: 'coronas_dendriticas',
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						//y1: red.box.y1-1
						y1: red.box.y1
					},
					coronas: [
						{peso: 1		, densidad: 1,		radioDesde: 0	, radioHasta: 0	, cantDendritas: 1},
						{peso: 0.3		, densidad: 1,		radioDesde: 1	, radioHasta: 1	, cantDendritas: 1},
						{peso: 0},
						{peso: -1.5		, densidad: 1,		radioDesde: 3	, radioHasta: 3	, cantDendritas: 1},
						{peso: 0.2		, densidad: 0.2,	radioDesde: 4	, radioHasta: 6	, cantDendritas: 1}
					]
				});
				
				
				
				
				
				/*
				
				Constructor.insertarAxones({
					modo: 'dendritas_radiales_pesadas',
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					dendritas_pesos: [1.0, 0.2, 0, -1.5, 0.2],
					
					
				});
				
				*/
				
				//Prueba con entrada relativa, para que fluya
				/*Constructor.insertarAxones({
					modo: 'relativo',
					dendritas_pesos: [-0.2],
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					boxRelativo	: {
						x0 	: -4,
						y0 	: 2,
						x1 	: 4,
						y1 	: 2
					}
				});
				
				Constructor.insertarAxones({
					modo: 'relativo',
					dendritas_pesos: [1.6],
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					boxRelativo	: {
						x0 	: -4,
						y0 	: 3,
						x1 	: 4,
						y1 	: 4
					}
				});
				
				*/
				
				/*
				//entrada con campana reforzada
				Constructor.insertarAxones({
					modo: 'dendritas_radiales_pesadas',
					dendritas_pesos: [1.0, 0.2, 0, -1.5, 0.2],
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y1-2,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					boxRelativo	: {
						x0 	: -5,
						y0 	: -1,
						x1 	: 5,
						y1 	: 0
					}
				});
				*/
				
				console.log('red created...');
				
				
				setRedContext();
				
				
			});
			
			$('#saveRed').on('click', function(){
				
				var _red = Constructor.getRedData();
				
				var _redString = JSON.stringify(_red);
				
				
				console.log('saving..........');
				
			});
			
			
			
			$('#loadRed').on('click', function(){
				
				var _red; //= JSON.parse(StringRed);
				
				red = Constructor.setRedData(_red);
				
				setRedContext();
				
				setControlCoeficientes();
			});
			


			$('#help').on('click', function(){
				window.location="https://github.com/josetabuyo/RedJavaScript/blob/master/README.md";
			});
			
			
			
			
			//TODO: COMMIG SOON: NEXT:
			//
			// agregar pdfs a git, agregar pila de refs a README
			// agregar a test multiples externos, y malos y buenos
			// subir a git
			
			//Terminar GuiMatriz
			// salvar en copytext el json de la configuracion de mapas y puntos con otros atributos variables
			//hacer la edicion de las neuronas de la red en base a la GuiMatriz: es más facil.
			//hacer la toolbar para dibujar el asistente de conexionado y editor de modelo de dendritas con la nueva GuiMatriz
			
			
		
			
			
			//TODO: DEBUG: sacar el "var"
			/*var*/ gui = new GuiMatriz({
				idSvg: 'dendritasModel_svg',
				drawObj: 'rectangulo',
				onAddMap: function(parent, capa){
					var chooseDendrita = $("<div>"+capa+"</div>");
					chooseDendrita.on('click', function(){
						parent.selMap(capa);
					});
					$('#dendritasModel_dendritas').append(chooseDendrita);
				}
			});
			
			$('#dendritasModel_toolbar>#drawMode').on('click', function(){
				gui.setDrawModeNext();
			});
			
			$('#dendritasModel_toolbar>#addDendrita').on('click', function(){
				gui.addMap();
			});
			
			
			
			
			$('#dendritasModel_Container').hide();
			$('#dendritasModel').on('click', function(){
				
				if($('#dendritasModel_Container').css('display') == 'none' ){
					$('#dendritasModel_Container').show();
					
				}else{
					$('#dendritasModel_Container').hide();
				}
			});
			
			
			
			
			
			
			
			
			
			console.log('*****************************************************');
			console.log('HELLO Red Neuronal HELLO - en Javascript by joZbuyo');
			console.log('*****************************************************');
			console.log('');
			console.log('*Probá moviendo las arrows keys a ver que pasa..');
			console.log('*Probá escribiendo "red;" en la consola también, si querés');
			console.log('');
			console.log('HELP:');
			console.log('https://github.com/josetabuyo/RedJavaScript/blob/master/README.md');
			console.log('');
			$('#newRed').click();
			test.play();
			
			/*
			setTimeout(function(){
				Vx.conectarCon(new NodoConectorSocket('http://localhost:3000'));
				//Vx.conectarCon(new NodoConectorSocket('https://router-vortex.herokuapp.com'));
				console.log('Conectado a servicio de vortex - FileBackend - en Heroku.');
			}, 1500);
			*/
			
			
		});
	</script>
</html>