<!DOCTYPE html>
<html>
	<head>
		<title>
			Red Neuronal by joZbuyo
		</title>
		<style>
			
			#svgRed{
				position: absolute;
				left: 0px;
				top: 40px;
				width: 40%;
				height: 90%;
				border: solid 1px;
				overflow: scroll;
			}
			
			#svgWorld{
				position: absolute;
				left: 40%;
				top: 40px;
				width: 39%;
				height: 90%;
				border: solid 1px;
				overflow: scroll;
			}
			
			#control{
				position: absolute;
				right: 0px;
				top: 40px;
				width: 20%;
				height: 90%;
				border: solid 1px;
				font-size: 10px;
			}
			
			#svgPatronesTest{
				position: absolute;
				right: 0px;
				top: 5px;
				width: 20%;
				height: 20px;
				border: solid 1px;
				overflow: scroll;
			}
			
			.boton{
				position: absolute;
				top: 5px;
				width: 60px;
				height: 20px;
				border: solid 1px;
			}

			#play{
				left: 20px;
				background-color: #66AA66;
			}
			#stop{
				left: 90px;
				background-color: #AA6666;
			}
			#step{
				left: 160px;
				background-color: #AAAAAA;
			}
			#verTensionSuperficial{
				left: 230px;
				background-color: #AAAAAA;
			}
			#resetRed{
				left: 300px;
				background-color: #AAAAAA;
			}
			#newRed{
				left: 370px;
				background-color: #AAAAAA;
			}
			#loadRed{
				left: 440px;
				background-color: #AAAAAA;
			}
			#saveRed{
				left: 510px;
				background-color: #AAAAAA;
			}

			
			#plantillas{
				display: none;
			}
			
			ul {
				list-style-type: none;
				margin:0;
				padding:0;
			}


			#plantilla_sly{
			
			}
			
			#plantilla_sly
			div.sly_ref{
				left: 20px;
				font-size: 9px;
			}
			
			#plantilla_sly
			input.sly_input{
				position: relative;
				top: 20px;
				left: 20px;
				width: 90%;
			}
			
		</style>
		
	</head>
	
	<body>
		<div id="play" class="boton">
			play
		</div>
		<div id="stop" class="boton">
			stop
		</div>
		
		<div id="step" class="boton">
			step
		</div>
		
		<div id="verTensionSuperficial" class="boton">
			tension
		</div>
		<div id="resetRed" class="boton">
			resetRed
		</div>
		<div id="newRed" class="boton">
			new red
		</div>
		<div id="loadRed" class="boton">
			load red
		</div>
		<div id="saveRed" class="boton">
			save red
		</div>
		
		<svg id="svgRed" >
		  <!-- rect x="0" y="0" width="10" height="10" style="fill:rgb(150,150,150);stroke:rgb(0,0,0);stroke-width:1;" / -->
		</svg>
		
		
		<svg id="svgWorld" >
		</svg>
		
		<div id="control">
			
			<ul id="coeficientes">
				<li>COEF_UMBRAL_SPIKE</li>
				<li>COEF_UMBRAL_SPIKE_MIN_TENSION</li>
				<li>COEF_TENSION_DECAIMIENTO</li>
				<li>COEF_DENDRITA_DECAIMIENTO</li>
				<li>COEF_SINAPSIS_ENTRENAMIENTO</li>
				<li>COEF_UMBRAL_SINAPSIS_PESO</li>
			<ul>
			
		</div>
		
		<svg id="svgPatronesTest" >
		  <!-- rect x="0" y="0" width="10" height="10" style="fill:rgb(150,150,150);stroke:rgb(0,0,0);stroke-width:1;" / -->
		</svg>
		
		
		<div id="plantillas">
			<li id="plantilla_sly">
				<div class="sly_ref">
				</div>
				<input class="sly_input" type="range" min="0" max="255" value="100" />
			</li>
		</div>
		
		
	</body>
	
	
	
	<script src="lib/jquery-2.1.3.min.js"></script>
	<script src="lib/snap.svg-min.js"></script>
	
	<script src="lib/vortex.min.js"></script>
	<script src="lib/socket.io.js"></script>
	<script src="lib/underscore-min.js"></script>
	
	
	<script src="GuiRed.js"></script>
	<script src="Test.js"></script>
	
	
	<script src="red/Constructor.js"></script>
	
	<script src="red/Red.js"></script>
	<script src="red/Neurona.js"></script>
	<script src="red/Axon.js"></script>
	<script src="red/Dendrita.js"></script>
	<script src="red/Sinapsis.js"></script>
		
	<script>
		
		//GLOBAL PARA FÁCIL DEBUG
		var red;
		var test;
		var guiRed;
		
		
		$(function(){
			
			
			
			
			$('body').on('contextmenu', function(e){
				e.stopPropagation();
				return false;
			});
			
			

			$('#play').on('click', function(){
				test.play();
			});
			$('#stop').on('click', function(){
				test.stop();
			});
			
			$('#step').on('click', function(){
				test.step();
			});
			
			
			$('#verTensionSuperficial').on('mousedown', function(){
				guiRed.modo="DEPOLARIZACION";
			});
			$('#verTensionSuperficial').on('mouseup', function(){
				guiRed.modo="ACTIVACION";
			});
			
			$('#resetRed').on('click', function(){
				for(iNeurona in red.neuronas){
					var oNeurona = red.neuronas[iNeurona];
					oNeurona.tensionSuperficial = 0;
					oNeurona.axon.valor = 0;
					for(iDendrita in oNeurona.dendritas){
						var oDendrita = oNeurona.dendritas[iDendrita];
						
						if(Object.keys(oDendrita.sinapsis).length > 0){
							var suma = 0;
							for(iSinapsis in oDendrita.sinapsis){
								var oSinapsis = oDendrita.sinapsis[iSinapsis];
								oSinapsis.peso = Math.random();
							}
						}
						
					};
				}
				var testIndex = Math.round(Math.random() * red.size.x);
				test.estado.current.neuronaCoord = {x: testIndex, y: red.size.y - 1};
			});
			
			
			
			
			
			
			
			
			
			$('ul#coeficientes>li').each(function(index, item){
				
				var nameSly = $(item).text();
				
				var newLi = $('#plantilla_sly').clone()
						.attr('id', nameSly+'_container');
				
				newLi.find('div.sly_ref').text(nameSly);
				
				newLi.find('input.sly_input').attr('id', nameSly);
				
				$(item).replaceWith(newLi)
			})
			
			
			
			var setControlCoeficientes = function(){
				var configSlyCoef = function(nameSly, proto){
					var objSly = $('#'+ nameSly);
					
					objSly.change(function(){
						var value = ($(this).val() / 255);
						
						proto[nameSly] = value.toFixed(3);;
						
						$(this).parent().find('div.sly_ref').text(nameSly + ": " + proto[nameSly]);
					});
					objSly.val(proto[nameSly] * 255);
					objSly.change();
				};
				
				
				configSlyCoef('COEF_UMBRAL_SINAPSIS_PESO', Red.prototype);
				configSlyCoef('COEF_UMBRAL_SPIKE', Neurona.prototype);
				configSlyCoef('COEF_UMBRAL_SPIKE_MIN_TENSION', Neurona.prototype);
				configSlyCoef('COEF_TENSION_DECAIMIENTO', Neurona.prototype);
				configSlyCoef('COEF_UMBRAL_SPIKE', Neurona.prototype);
				configSlyCoef('COEF_DENDRITA_DECAIMIENTO', Dendrita.prototype);
				configSlyCoef('COEF_SINAPSIS_ENTRENAMIENTO', Sinapsis.prototype);
			
			};
			
			
			
			setControlCoeficientes();
			
			
			
			var setRedContext = function(){
				
				guiRed = new GuiRed({
					red: red,
					x: 1,
					y: 1
				});
				
				
				//DEBUG: boxEntrada y boxSalida
				// no deberían estar acá,
				//no sé como hacer para que se obtenga de la red a testear,
				//puede ser que lo guarde como dato de la red, debería poder no usarse
				
				var boxEntrada = {
					x0: 0,
					y0: red.size.y - 1,
					x1: red.size.x - 1,
					y1: red.size.y - 1
				};
				var boxSalida = {
					x0: 0,
					y0: 0,
					x1: red.size.x - 1,
					y1: 0
				};
				
				
				
				
				test = new Test({
					red: red,
					boxEntrada: boxEntrada,
					boxSalida: boxSalida,
					noise: false
				});
				
				
				//TODO: cargo y pongo play al test del mundillo
				//TODO: configurar el auto-run, independiente de la red.procesar, ambos asincrónicos.
				/*
				test.world.playInterval = setInterval(function() {
					test.world.step();
				},10);
				*/
				
				red.onProcesar(function(){
					guiRed.refresh();
				});
				
			};
			
			
			$('#newRed').on('click', function(){
				//crear red
				red = new Red({
					size: {x:32,y:32},
					neuronas: {}
				});
				
				
				Constructor.red = red;
				
				
				var boxEntrada = {
					x0: 0,
					y0: red.size.y - 1,
					x1: red.size.x - 1,
					y1: red.size.y - 1
				};
				Constructor.makeEntrada(boxEntrada);
				
				
				var boxSalida = {
					x0: 0,
					y0: 0,
					x1: red.size.x - 1,
					y1: 0
				};
				Constructor.makeSalida(boxSalida);
				
				Constructor.insertarAxones({
					modo: 'dendritas_radiales_pesadas',
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					dendritas_pesos: [1.0, 0.2, 0, -1.5, 0.2]
				});
				
				/*
				//Conexion a la Entrada Feed Foward! (entendí el concepto de HTM de entrada feedfoward, éstas provocan la activación directa)
				
				Constructor.insertarAxones({
					modo: 'full_random_fixed_input',
					dendritas_pesos: [1.5],
					densidadConexionado: 0.7,
					boxEntrada: boxEntrada,
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					}
				});
				*/
				
				//Prueba con entrada relativa, para que fluya
				Constructor.insertarAxones({
					modo: 'relativo',
					dendritas_pesos: [-0.2],
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					boxRelativo	: {
						x0 	: -4,
						y0 	: 2,
						x1 	: 4,
						y1 	: 2
					}
				});
				
				Constructor.insertarAxones({
					modo: 'relativo',
					dendritas_pesos: [1.6],
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y0,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					boxRelativo	: {
						x0 	: -4,
						y0 	: 3,
						x1 	: 4,
						y1 	: 4
					}
				});
				
				
				
				/*
				//entrada con campana reforzada
				Constructor.insertarAxones({
					modo: 'dendritas_radiales_pesadas',
					dendritas_pesos: [1.0, 0.2, 0, -1.5, 0.2],
					boxTarget: {
						x0: red.box.x0,
						y0: red.box.y1-2,
						x1: red.box.x1,
						y1: red.box.y1-1
					},
					boxRelativo	: {
						x0 	: -5,
						y0 	: -1,
						x1 	: 5,
						y1 	: 0
					}
				});
				*/
				
				console.log('red created...');
				
				
				setRedContext();
				
				
			});
			
			$('#saveRed').on('click', function(){
				
				var _red = Constructor.getRedData();
				
				
				Vx.send({
					tipoDeMensaje: 'escribirArchivo',
					path:'red.json',
					data: JSON.stringify(_red)
					
				}, function(mensaje){
					console.log('red saved...');
					console.log(mensaje);
				});
			});
			
			
			
			$('#loadRed').on('click', function(){
				
				Vx.send({
					tipoDeMensaje: 'leerArchivo',
					path:'red.json'
					
				}, function(mensaje){
					
					var _red = JSON.parse(mensaje.data);
					
					red = Constructor.setRedData(_red);
					
					console.log('red loaded...');
					
					setRedContext();
					
					setControlCoeficientes();
					
				});
			});
			
			
			
			console.log('*****************************************************');
			console.log('HELLO Red Neuronal HELLO - en Javascript by joZbuyo');
			console.log('*****************************************************');
			console.log('');
			console.log('*Probá moviendo las arrows keys a ver que pasa..');
			console.log('');
			$('#newRed').click();
			$('#play').click();
			
			setTimeout(function(){
				Vx.conectarCon(new NodoConectorSocket('http://localhost:3000'));
				console.log('Conectado a servicio de vortex - FileBackend.');
			}, 1500);
			
			
			
			
		});
	</script>
</html>